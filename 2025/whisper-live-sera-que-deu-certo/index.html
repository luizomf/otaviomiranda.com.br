<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Tentei usar o whisper live via microfone - Ot√°vio Miranda</title>
    <meta
      name="description"
      content="Criei essa p√°gina para documentar minhas tentativas de usar o whisper live via microfone. J√° quero deixar claro que isso n√£o funcionou conforme eu esperava e cabem mais testes."
    />

    <link rel="stylesheet" href="../../css/styles_2026.css" />

    <link rel="icon" type="image/webp" href="../../imgs/favicon-1.webp" />

    <!-- conex√£o antecipada -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- fonte -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <input
      aria-label="Tema Claro ou Escuro (Tempor√°rio)"
      title="Tema Claro ou Escuro (Tempor√°rio)"
      id="theme-mode"
      type="checkbox"
    />

    <main class="main">
      <aside class="nav">
        <a class="copyright-link" href="/">Ot√°vio Miranda</a>
        <a
          target="_blank"
          href="https://beacons.ai/otaviomiranda"
          rel="nofollow noopener noreferrer"
          >Contatos</a
        >
      </aside>

      <article class="article" id="content">
        <h1>(üö´ FAILED) <code>whisper</code> em tempo real via microfone</h1>
        <p class="author">
          <span class="meta-date">
            <time datetime="2025-10-02">2 de outubro de 2025</time>
          </span>
          ¬∑
          <span class="meta-author">Luiz Ot√°vio Miranda</span>
        </p>
        <p>
          Criei esse arquivo pra ir anotando minhas tentativas de rodar o
          <code>whisper</code> em tempo real, puxando o √°udio direto do
          microfone. J√° vou
          <strong>deixar claro que isso n√£o funcionou</strong> do jeito que eu
          esperava, e ainda tem coisa pra testar.
        </p>
        <p>
          Na minha cabe√ßa, talvez o certo fosse trabalhar direto com o modelo do
          <code>whisper</code>, sem usar o c√≥digo oficial da OpenAI. Aquela
          janela fixa de 30 segundos pode ter atrapalhado real. Pode at√© ser que
          precise refinar o modelo pra rodar liso num esquema <em>live</em>.
        </p>
        <p>
          Mas enfim... isso √© s√≥ uma ideia. N√£o fui muito al√©m do que t√°
          descrito aqui porque quero ver primeiro se esse tipo de conte√∫do
          realmente chama aten√ß√£o do pessoal pra eu focar mais tempo pra gerar
          conte√∫do (v√≠deos, posts, aulas, etc).
        </p>
        <p>
          <img
            src="images/whisper-failed-1.webp"
            alt="Figura humanoide futurista feita de circuitos, sussurrando em um microfone, triste."
          />
          <em>Imagem: Reprodu√ß√£o / IA</em>
        </p>

        <hr />
        <h2>(üö´ FAILED) Captura do microfone via <code>ffmpeg</code></h2>
        <p>
          Minha primeira tentativa foi capturar o √°udio do computador usando o
          <code>ffmpeg</code>.
        </p>
        <p>
          Pra deixar claro: t√¥ usando o ChatGPT e o Gemini pra me ajudar nas
          partes que eu manjo menos, principalmente as coisas mais t√©cnicas de
          √°udio. Al√©m disso, t√¥ rodando tudo com esse setup aqui (n√£o sei se faz
          diferen√ßa, mas vai que...):
        </p>
        <ul>
          <li>MacBook Pro 2021</li>
          <li>Chip Apple M1 Max</li>
          <li>32 GB de RAM</li>
          <li>SSD de 1 TB</li>
          <li>macOS Sequoia 15.5</li>
        </ul>
        <hr />
        <h3>Listando os dispositivos de √°udio</h3>
        <p><strong>Obs:</strong> t√¥ testando s√≥ no macOS por enquanto.</p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#9399B2;font-style:italic"># macOS</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#A6E3A1"> -hide_banner</span><span style="color:#A6E3A1"> -f</span><span style="color:#A6E3A1"> avfoundation</span><span style="color:#A6E3A1"> -list_devices</span><span style="color:#FAB387"> true</span><span style="color:#A6E3A1"> -i</span><span style="color:#A6E3A1"> ""</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic"># Linux</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#A6E3A1"> -hide_banner</span><span style="color:#A6E3A1"> -f</span><span style="color:#A6E3A1"> alsa</span><span style="color:#A6E3A1"> -list_devices</span><span style="color:#FAB387"> true</span><span style="color:#A6E3A1"> -i</span><span style="color:#A6E3A1"> ""</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic"># ou (√†s vezes mais confi√°vel)</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">arecord</span><span style="color:#A6E3A1"> -l</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic"># ou</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">arecord</span><span style="color:#A6E3A1"> --list-devices</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic"># Windows</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#A6E3A1"> -hide_banner</span><span style="color:#A6E3A1"> -list_devices</span><span style="color:#FAB387"> true</span><span style="color:#A6E3A1"> -f</span><span style="color:#A6E3A1"> dshow</span><span style="color:#A6E3A1"> -i</span><span style="color:#A6E3A1"> dummy</span></span></code></pre>
        <p>
          No meu caso, a sa√≠da foi mais ou menos como a que mostro logo abaixo.
          S√≥ dei uma enxugada, tirando os dispositivos que n√£o interessavam
          (tipo fone, celular, etc). Tamb√©m cortei aquele trecho inicial que o
          ffmpeg cospe sempre.
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#89B4FA;font-style:italic">‚ûú</span><span style="color:#A6E3A1">  Desktop</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#A6E3A1"> -hide_banner</span><span style="color:#A6E3A1"> -f</span><span style="color:#A6E3A1"> avfoundation</span><span style="color:#A6E3A1"> -list_devices</span><span style="color:#FAB387"> true</span><span style="color:#A6E3A1"> -i</span><span style="color:#A6E3A1"> ""</span><span style="color:#94E2D5"> 2>&#x26;1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">2025-06-18</span><span style="color:#A6E3A1"> 09:15:21.567</span><span style="color:#A6E3A1"> ffmpeg[37312:1839628]</span><span style="color:#A6E3A1"> WARNING:</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">Add</span><span style="color:#A6E3A1"> NSCameraUseContinuityCameraDeviceType</span><span style="color:#A6E3A1"> to</span><span style="color:#A6E3A1"> your</span><span style="color:#A6E3A1"> Info.plist</span><span style="color:#A6E3A1"> to</span><span style="color:#A6E3A1"> use</span><span style="color:#A6E3A1"> AVCaptureDeviceTypeContinuityCamera.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">2025-06-18</span><span style="color:#A6E3A1"> 09:15:21.708</span><span style="color:#A6E3A1"> ffmpeg[37312:1839628]</span><span style="color:#A6E3A1"> WARNING:</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">AVCaptureDeviceTypeExternal</span><span style="color:#A6E3A1"> is</span><span style="color:#A6E3A1"> deprecated</span><span style="color:#A6E3A1"> for</span><span style="color:#A6E3A1"> Continuity</span><span style="color:#A6E3A1"> Cameras.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">Please</span><span style="color:#A6E3A1"> use</span><span style="color:#A6E3A1"> AVCaptureDeviceTypeContinuityCamera</span><span style="color:#A6E3A1"> and</span><span style="color:#A6E3A1"> add</span><span style="color:#A6E3A1"> NSCameraUseContinuityCameraDeviceType</span><span style="color:#A6E3A1"> to</span><span style="color:#A6E3A1"> your</span><span style="color:#A6E3A1"> Info.plist.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> AVFoundation video devices:</span></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">0</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> C√¢mera FaceTime HD</span></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">5</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> Capture screen 0</span></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">6</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> Capture screen 1</span></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> AVFoundation audio devices:</span></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">0</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> MOTIV Mix Virtual</span></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">1</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> JBL TUNE125BT FOREBA</span></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">AVFoundation indev @ 0x153706960</span><span style="color:#9399B2">]</span><span style="color:#9399B2"> [</span><span style="color:#CDD6F4">2</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> Microfone (</span><span style="color:#89B4FA;font-style:italic">MacBook</span><span style="color:#A6E3A1"> Pro</span><span style="color:#CDD6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2">[</span><span style="color:#CDD6F4">in#0 @ 0x600001f5c600</span><span style="color:#9399B2">]</span><span style="color:#CDD6F4"> Error opening input: Input/output error</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">Error</span><span style="color:#A6E3A1"> opening</span><span style="color:#A6E3A1"> input</span><span style="color:#A6E3A1"> file</span><span style="color:#A6E3A1"> .</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">Error</span><span style="color:#A6E3A1"> opening</span><span style="color:#A6E3A1"> input</span><span style="color:#A6E3A1"> files:</span><span style="color:#A6E3A1"> Input/output</span><span style="color:#A6E3A1"> error</span></span></code></pre>
        <p>
          A parte importante dessa sa√≠da √© saber duas coisas: o
          <code>[ID]</code> e o nome do dispositivo.
        </p>
        <p>
          Por exemplo, se eu quiser usar o
          <strong>Microfone (MacBook Pro)</strong>, isso quer dizer que o ID do
          dispositivo de √°udio que eu vou usar √© o <code>2</code>.
        </p>
        <hr />
        <h3>(üö´ FAILED) Testando a captura de √°udio em um <code>.wav</code></h3>
        <p>
          Antes de tudo, bora garantir que t√° tudo funcionando bonitinho. A
          ideia aqui √© s√≥ gravar um <code>.wav</code> com o √°udio capturado
          direto do microfone. Ainda n√£o √© o comando final, √© s√≥ pra testar
          mesmo.
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#9399B2;font-style:italic"># Lembra do meu [2] Microfone (MacBook Pro) -> ID 2</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic"># No comando abaixo, o ":2" representa o dispositivo que eu t√¥ usando</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic"># Resultado: grava um arquivo out.wav com 10 segundos de √°udio</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#A6E3A1"> -f</span><span style="color:#A6E3A1"> avfoundation</span><span style="color:#A6E3A1"> -i</span><span style="color:#A6E3A1"> ":2"</span><span style="color:#A6E3A1"> -t</span><span style="color:#FAB387"> 10</span><span style="color:#A6E3A1"> -ac</span><span style="color:#FAB387"> 1</span><span style="color:#A6E3A1"> -ar</span><span style="color:#FAB387"> 16000</span><span style="color:#A6E3A1"> out.wav</span></span></code></pre>
        <p>
          Ou seja, pra capturar s√≥ o
          <strong>[2] Microfone (MacBook Pro)</strong>, √© s√≥ passar
          <code>:2</code> no argumento <code>-i</code>.
        </p>
        <p>
          Se tu quiser capturar <strong>v√≠deo e √°udio ao mesmo tempo</strong>, o
          formato vira <code>V:A</code>, onde <code>V</code> √© o ID do v√≠deo e
          <code>A</code> o do √°udio.
        </p>
        <p>Tipo assim:</p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#9399B2;font-style:italic"># Captura da C√¢mera FaceTime HD (ID 0) + Microfone (MacBook Pro) (ID 2)</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic"># Grava um out.mp4 com 10 segundos de v√≠deo e √°udio dos dispositivos 0 e 2</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#A6E3A1"> -f</span><span style="color:#A6E3A1"> avfoundation</span><span style="color:#A6E3A1"> -framerate</span><span style="color:#FAB387"> 30</span><span style="color:#A6E3A1"> -i</span><span style="color:#A6E3A1"> "0:2"</span><span style="color:#A6E3A1"> -t</span><span style="color:#FAB387"> 10</span><span style="color:#A6E3A1"> out.mp4</span></span></code></pre>
        <hr />
        <h3>(üö´ FAILED) O que rolou com o <code>ffmpeg</code>?</h3>
        <p>
          No meu caso, o <code>ffmpeg</code> n√£o funcionou do jeito que eu
          queria. O √°udio ficou todo picotado, com umas falhas bem esquisitas.
          Da√≠ pra frente, passei praticamente o dia inteiro testando v√°rias
          coisas: mudei o <em>sample rate</em>, tentei outros <em>codecs</em>,
          troquei de microfone, testei outras fontes (at√© tentei capturar o som
          direto do sistema). Nada deu certo.
        </p>
        <p>
          Minha conclus√£o: o <code>avfoundation</code> no meu macOS n√£o t√° se
          comportando direito.
        </p>
        <p>Testei comandos como esse aqui:</p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -thread_queue_size</span><span style="color:#FAB387"> 512</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -loglevel</span><span style="color:#A6E3A1"> debug</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -f</span><span style="color:#A6E3A1"> avfoundation</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -i</span><span style="color:#A6E3A1"> ":2"</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -c:a</span><span style="color:#A6E3A1"> copy</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -t</span><span style="color:#FAB387"> 10</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    out.wav</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -y</span></span></code></pre>
        <p>
          Esse <code>-c:a copy</code> (pra manter o codec de √°udio original) foi
          uma das √∫ltimas tentativas, depois de trocar um monte de outras
          coisas. E com isso o ffmpeg revelou que o √°udio tava vindo com essas
          specs:
        </p>
        <pre><code>Stream #0:0, 1, 1/1000000: Audio: pcm_f32le, 48000 Hz, mono, flt, 1536 kb/s
</code></pre>
        <p>
          Eu j√° tinha testado <code>pcm_f32le</code> com
          <code>48000 Hz</code> antes, ent√£o... nenhuma surpresa.
        </p>
        <p>
          Enfim, deixo isso aqui documentado porque, se acontecer contigo
          tamb√©m, j√° te poupo umas horas de frustra√ß√£o. A √∫nica coisa que
          resolveu o problema de √°udio tremido/picotado foi
          <strong>usar o <code>sox</code></strong
          >.
        </p>
        <hr />
        <h2>(‚úÖ SUCCESS) <code>sox</code> pra capturar o √°udio</h2>
        <p>
          Na primeira tentativa com <code>sox</code>, j√° rolou de boa,
          <strong>zero esfor√ßo</strong>.
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#89B4FA;font-style:italic">sox</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -b</span><span style="color:#FAB387"> 32</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -e</span><span style="color:#A6E3A1"> float</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -r</span><span style="color:#FAB387"> 16000</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -c</span><span style="color:#FAB387"> 1</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -d</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    --buffer</span><span style="color:#9399B2"> $((</span><span style="color:#89B4FA;font-style:italic">16000*4*10</span><span style="color:#9399B2">))</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    out.wav</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    trim</span><span style="color:#FAB387"> 0</span><span style="color:#FAB387"> 10</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    fade</span><span style="color:#A6E3A1"> t</span><span style="color:#FAB387"> 1</span><span style="color:#A6E3A1"> -0</span><span style="color:#FAB387"> 1</span></span></code></pre>
        <p>
          Esse comando foi gerado pelo Gemini ou ChatGPT (n√£o lembro). S√≥ pedi
          um exemplo que gravasse 10 segundos de √°udio com fade-in e fade-out,
          s√≥ pra teste mesmo.
        </p>
        <p>
          Depois fui testando outras paradas, mas o comando que pretendo usar
          com o <code>whisper</code> √© esse aqui:
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#9399B2;font-style:italic"># üö´ n√£o executa ainda</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">sox</span><span style="color:#A6E3A1"> -t</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    coreaudio</span><span style="color:#A6E3A1"> "Microfone (MacBook Pro)"</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -b</span><span style="color:#FAB387"> 16</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -e</span><span style="color:#A6E3A1"> signed-integer</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -r</span><span style="color:#FAB387"> 16000</span><span style="color:#A6E3A1"> -c</span><span style="color:#FAB387"> 1</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -t</span><span style="color:#A6E3A1"> raw</span><span style="color:#F5C2E7"> \</span></span>
<span class="line"><span style="color:#A6E3A1">    -</span></span></code></pre>
        <p>
          Repara que a sa√≠da t√° indo pro <code>stdout</code> (por isso tem esse
          <code>-</code> no fim), n√£o pra um arquivo. Ou seja, isso aqui √© s√≥ a
          base pra integrar com outro processo, tipo jogar direto no
          <code>whisper</code>.
        </p>
        <p>
          Eu n√£o entendo muito do <code>sox</code> ainda (primeiro uso), mas
          usei o <code>ffmpeg</code> (l√° em cima) pra listar os dispositivos. E
          aqui √© diferente: em vez de usar o ID como no <code>ffmpeg</code>, tu
          passa o nome do dispositivo, tipo, meu caso:
          <code>"Microfone (MacBook Pro)"</code>.
        </p>
        <hr />
        <h2>(ü§î SUCCESS?) <code>whisper</code> live, ou quase</h2>
        <p>
          Aqui √© onde come√ßo a achar que talvez eu precise refinar o modelo ou
          at√© usar ele "cru", sem passar pelo c√≥digo oficial da OpenAI
          (<code>whisper</code>).
        </p>
        <p>
          Fiz um c√≥digo bem porquinho, s√≥ pra
          <strong>ver se ia funcionar</strong>. A ideia era: se desse certo, a√≠
          sim eu refinava tudo com calma.
        </p>
        <p>
          Considera isso aqui como um <em>MVP</em> na vers√£o
          <code>0.0.0alpha</code> mesmo.
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#9399B2;font-style:italic"># pyright: basic</span></span>
<span class="line"><span style="color:#CBA6F7">import</span><span style="color:#CDD6F4"> asyncio</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">import</span><span style="color:#CDD6F4"> numpy </span><span style="color:#CBA6F7">as</span><span style="color:#CDD6F4"> np</span></span>
<span class="line"><span style="color:#CBA6F7">import</span><span style="color:#CDD6F4"> whisper</span></span>
<span class="line"><span style="color:#CBA6F7">from</span><span style="color:#CDD6F4"> scipy</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">io </span><span style="color:#CBA6F7">import</span><span style="color:#CDD6F4"> wavfile</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">MODEL </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">load_model</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1">"turbo"</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">async</span><span style="color:#CBA6F7"> def</span><span style="color:#89B4FA;font-style:italic"> recorder</span><span style="color:#9399B2">(</span><span style="color:#EBA0AC;font-style:italic">queue</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> counter</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> buffer</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> chunk_size</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> sr</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">16000</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> duration</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">5</span><span style="color:#9399B2">):</span></span>
<span class="line"><span style="color:#FAB387;font-style:italic">    print</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1">"üó£Ô∏è Recording started"</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">    proc </span><span style="color:#94E2D5">=</span><span style="color:#CBA6F7"> await</span><span style="color:#CDD6F4"> asyncio</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">create_subprocess_exec</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#A6E3A1">        "sox"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "-t"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "coreaudio"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "Microfone (MacBook Pro)"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "-b"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "16"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "-e"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "signed-integer"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "-r"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "16000"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "-c"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "1"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "-t"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "raw"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#A6E3A1">        "-"</span><span style="color:#9399B2">,</span><span style="color:#9399B2;font-style:italic">  # raw para facilitar o corte</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">        stdout</span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4">asyncio</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">subprocess</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">PIPE</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">        stderr</span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4">asyncio</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">subprocess</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">DEVNULL</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#9399B2">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">    while</span><span style="color:#FAB387"> True</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#CDD6F4">        data </span><span style="color:#94E2D5">=</span><span style="color:#CBA6F7"> await</span><span style="color:#CDD6F4"> proc</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">stdout</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">read</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">chunk_size</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#CBA6F7">        if</span><span style="color:#CBA6F7"> not</span><span style="color:#CDD6F4"> data</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#CBA6F7">            break</span></span>
<span class="line"><span style="color:#CDD6F4">        buffer </span><span style="color:#94E2D5">+=</span><span style="color:#CDD6F4"> data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">        chunk_byte_size </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> sr </span><span style="color:#94E2D5">*</span><span style="color:#FAB387"> 2</span><span style="color:#94E2D5"> *</span><span style="color:#CDD6F4"> duration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">        if</span><span style="color:#FAB387;font-style:italic"> len</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">buffer</span><span style="color:#9399B2">)</span><span style="color:#94E2D5"> >=</span><span style="color:#CDD6F4"> chunk_byte_size</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#CDD6F4">            audio_chunk </span><span style="color:#94E2D5">=</span><span style="color:#EBA0AC;font-style:italic"> buffer</span><span style="color:#9399B2">[:</span><span style="color:#EBA0AC;font-style:italic">chunk_byte_size</span><span style="color:#9399B2">]</span></span>
<span class="line"><span style="color:#CDD6F4">            buffer </span><span style="color:#94E2D5">=</span><span style="color:#EBA0AC;font-style:italic"> buffer</span><span style="color:#9399B2">[</span><span style="color:#EBA0AC;font-style:italic">chunk_byte_size</span><span style="color:#9399B2">:]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">            audio_np </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> np</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">frombuffer</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio_chunk</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> np</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">int16</span><span style="color:#9399B2">).</span><span style="color:#89B4FA">astype</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">np</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">float32</span><span style="color:#9399B2">)</span><span style="color:#94E2D5"> /</span><span style="color:#FAB387"> 32768.0</span></span>
<span class="line"><span style="color:#CBA6F7">            await</span><span style="color:#CDD6F4"> queue</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">put</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio_np</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">            wavfile</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">write</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#A6E3A1;font-style:italic">                f</span><span style="color:#A6E3A1">"media/debug_</span><span style="color:#F5C2E7">{</span><span style="color:#CDD6F4">counter</span><span style="color:#F5C2E7">}</span><span style="color:#A6E3A1">.wav"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#FAB387">                16000</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#CDD6F4">                audio_np</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#9399B2">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FAB387;font-style:italic">            print</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1;font-style:italic">f</span><span style="color:#A6E3A1">"üó£Ô∏è Chunk </span><span style="color:#F5C2E7">{</span><span style="color:#CDD6F4">counter</span><span style="color:#F5C2E7">}</span><span style="color:#A6E3A1"> ends </span><span style="color:#F5C2E7">\n</span><span style="color:#A6E3A1">"</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#CDD6F4">            counter </span><span style="color:#94E2D5">+=</span><span style="color:#FAB387"> 1</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">async</span><span style="color:#CBA6F7"> def</span><span style="color:#89B4FA;font-style:italic"> transcriber</span><span style="color:#9399B2">(</span><span style="color:#EBA0AC;font-style:italic">queue</span><span style="color:#9399B2">):</span></span>
<span class="line"><span style="color:#CDD6F4">    prefix </span><span style="color:#94E2D5">=</span><span style="color:#A6E3A1"> ""</span></span>
<span class="line"><span style="color:#CBA6F7">    while</span><span style="color:#FAB387"> True</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#FAB387;font-style:italic">        print</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1">"üí¨ Whisper started"</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">        audio </span><span style="color:#94E2D5">=</span><span style="color:#CBA6F7"> await</span><span style="color:#CDD6F4"> queue</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">get</span><span style="color:#9399B2">()</span></span>
<span class="line"><span style="color:#CDD6F4">        audio </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">pad_or_trim</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">        mel </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">log_mel_spectrogram</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> n_mels</span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4">MODEL</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">dims</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">n_mels</span><span style="color:#9399B2">).</span><span style="color:#89B4FA">to</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#CDD6F4">            MODEL</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">device</span></span>
<span class="line"><span style="color:#9399B2">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">        options </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">DecodingOptions</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            language</span><span style="color:#94E2D5">=</span><span style="color:#A6E3A1">"en"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            temperature</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">0</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            beam_size</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">1</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            patience</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">0</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            without_timestamps</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">True</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            prompt</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">None</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            prefix</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">None</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#9399B2">        )</span></span>
<span class="line"><span style="color:#CDD6F4">        result </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">decode</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#CDD6F4">            MODEL</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#CDD6F4">            mel</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#CDD6F4">            options</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#9399B2">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">        prefix </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> result</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">text</span></span>
<span class="line"><span style="color:#FAB387;font-style:italic">        print</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1">"üí¨"</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> result</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">text</span><span style="color:#9399B2">,</span><span style="color:#A6E3A1"> "</span><span style="color:#F5C2E7">\n</span><span style="color:#A6E3A1">"</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#CDD6F4">        queue</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">task_done</span><span style="color:#9399B2">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">async</span><span style="color:#CBA6F7"> def</span><span style="color:#89B4FA;font-style:italic"> main</span><span style="color:#9399B2">():</span></span>
<span class="line"><span style="color:#CBA6F7">    from</span><span style="color:#CDD6F4"> pathlib </span><span style="color:#CBA6F7">import</span><span style="color:#CDD6F4"> Path</span></span>
<span class="line"><span style="color:#CBA6F7">    from</span><span style="color:#CDD6F4"> shutil </span><span style="color:#CBA6F7">import</span><span style="color:#CDD6F4"> rmtree</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">    media </span><span style="color:#94E2D5">=</span><span style="color:#89B4FA"> Path</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1">"media"</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#89B4FA">    rmtree</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">media</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#CDD6F4">    media</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">mkdir</span><span style="color:#9399B2">(</span><span style="color:#EBA0AC;font-style:italic">exist_ok</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">True</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">    queue </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> asyncio</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">Queue</span><span style="color:#9399B2">()</span></span>
<span class="line"><span style="color:#CDD6F4">    counter </span><span style="color:#94E2D5">=</span><span style="color:#FAB387"> 0</span></span>
<span class="line"><span style="color:#CDD6F4">    buffer </span><span style="color:#94E2D5">=</span><span style="color:#A6E3A1;font-style:italic"> b</span><span style="color:#A6E3A1">""</span></span>
<span class="line"><span style="color:#CDD6F4">    chunk_size </span><span style="color:#94E2D5">=</span><span style="color:#FAB387"> 4096</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">    await</span><span style="color:#CDD6F4"> asyncio</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">gather</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#89B4FA">        recorder</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">queue</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> counter</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> buffer</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> chunk_size</span><span style="color:#9399B2">,</span><span style="color:#FAB387"> 16000</span><span style="color:#9399B2">,</span><span style="color:#FAB387"> 30</span><span style="color:#9399B2">),</span><span style="color:#89B4FA"> transcriber</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">queue</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#9399B2">    )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#CBA6F7">if</span><span style="color:#CDD6F4"> __name__ </span><span style="color:#94E2D5">==</span><span style="color:#A6E3A1"> "__main__"</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#CDD6F4">    asyncio</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">run</span><span style="color:#9399B2">(</span><span style="color:#89B4FA">main</span><span style="color:#9399B2">())</span></span></code></pre>
        <p>
          Nesse c√≥digo eu uso <code>asyncio</code> justamente pra n√£o travar
          tudo enquanto o <code>whisper</code> t√° transcrevendo. A ideia √©
          deixar o processo rodando em paralelo: enquanto uma parte grava, a
          outra j√° vai transcrevendo em tempo real.
        </p>
        <p>
          Tamb√©m uso o <code>scipy.io.wavfile</code> pra salvar os √°udios em
          <em>chunks</em>, do mesmo jeitinho que o <code>whisper</code> recebe.
          Isso ajuda no debug: depois eu junto esses arquivos e escuto como
          ficou o √°udio real que foi processado.
        </p>
        <p>
          A fun√ß√£o <code>recorder</code> √© quem inicia o <code>sox</code> com o
          microfone que escolhi e roda um loop que fica monitorando a quantidade
          de bytes acumulados. Essa contagem √© baseada no tamanho que cada
          trecho de √°udio teria, considerando a dura√ß√£o que defini.
        </p>
        <pre><code class="language-python"># Sample rate (16000) * Sample Width (2 bytes) * dura√ß√£o (ex: 5s)
chunk_byte_size = sr * 2 * duration
</code></pre>
        <p>
          Quando o tamanho do <code>buffer</code> atinge esse
          <code>chunk_byte_size</code>, a gente corta exatamente at√© ali. Esses
          s√£o os bytes crus do trecho de √°udio que vai pra transcri√ß√£o. Em
          seguida, o <code>buffer</code> √© atualizado pra remover esse peda√ßo
          processado e guardar qualquer sobra, que vai ser usada no pr√≥ximo
          ciclo.
        </p>
        <p>
          Esse loop aqui embaixo √© o cora√ß√£o da grava√ß√£o. Ele fica rodando
          enquanto o <code>sox</code> t√° mandando dados pela
          <code>stdout</code>.
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#CBA6F7">while</span><span style="color:#FAB387"> True</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">    # captura o que vem do sox</span></span>
<span class="line"><span style="color:#CDD6F4">    data </span><span style="color:#94E2D5">=</span><span style="color:#CBA6F7"> await</span><span style="color:#CDD6F4"> proc</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">stdout</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">read</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">chunk_size</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#CBA6F7">    if</span><span style="color:#CBA6F7"> not</span><span style="color:#CDD6F4"> data</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#CBA6F7">        break</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">    # joga no buffer</span></span>
<span class="line"><span style="color:#CDD6F4">    buffer </span><span style="color:#94E2D5">+=</span><span style="color:#CDD6F4"> data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">    # calcula quantos bytes correspondem √† duration configurada</span></span>
<span class="line"><span style="color:#CDD6F4">    chunk_byte_size </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> sr </span><span style="color:#94E2D5">*</span><span style="color:#FAB387"> 2</span><span style="color:#94E2D5"> *</span><span style="color:#CDD6F4"> duration</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">    # se o buffer j√° tiver o tamanho certo pra um trecho de √°udio completo</span></span>
<span class="line"><span style="color:#CBA6F7">    if</span><span style="color:#FAB387;font-style:italic"> len</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">buffer</span><span style="color:#9399B2">)</span><span style="color:#94E2D5"> >=</span><span style="color:#CDD6F4"> chunk_byte_size</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # pegamos s√≥ o peda√ßo que interessa</span></span>
<span class="line"><span style="color:#CDD6F4">        audio_chunk </span><span style="color:#94E2D5">=</span><span style="color:#EBA0AC;font-style:italic"> buffer</span><span style="color:#9399B2">[:</span><span style="color:#EBA0AC;font-style:italic">chunk_byte_size</span><span style="color:#9399B2">]</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # e atualizamos o buffer, removendo o que j√° usamos</span></span>
<span class="line"><span style="color:#CDD6F4">        buffer </span><span style="color:#94E2D5">=</span><span style="color:#EBA0AC;font-style:italic"> buffer</span><span style="color:#9399B2">[</span><span style="color:#EBA0AC;font-style:italic">chunk_byte_size</span><span style="color:#9399B2">:]</span></span></code></pre>
        <p>
          A√≠, com esse <code>audio_chunk</code> em m√£os, √© s√≥ converter pra um
          formato que o <code>whisper</code> entenda e jogar isso na
          <code>queue</code>, que o <code>transcriber</code> vai processar
          depois:
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#CDD6F4">audio_np </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> np</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">frombuffer</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio_chunk</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> np</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">int16</span><span style="color:#9399B2">).</span><span style="color:#89B4FA">astype</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">np</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">float32</span><span style="color:#9399B2">)</span><span style="color:#94E2D5"> /</span><span style="color:#FAB387"> 32768.0</span></span>
<span class="line"><span style="color:#CBA6F7">await</span><span style="color:#CDD6F4"> queue</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">put</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio_np</span><span style="color:#9399B2">)</span></span></code></pre>
        <p>
          Esse <code>.frombuffer(...).astype(...) / 32768.0</code> basicamente
          transforma os bytes crus em um array de <code>float32</code> com
          valores normalizados entre -1 e 1, que √© o formato que o
          <code>whisper</code> espera.
        </p>
        <p>
          Como eu queria ver exatamente o que o <code>whisper</code> tamb√©m
          "tava enxergando", salvei cada trecho de √°udio assim:
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#CDD6F4">wavfile</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">write</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#A6E3A1;font-style:italic">    f</span><span style="color:#A6E3A1">"media/debug_</span><span style="color:#F5C2E7">{</span><span style="color:#CDD6F4">counter</span><span style="color:#F5C2E7">}</span><span style="color:#A6E3A1">.wav"</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#FAB387">    16000</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#CDD6F4">    audio_np</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#9399B2">)</span></span></code></pre>
        <p>
          Usei esse <code>counter</code> s√≥ pra gerar arquivos separados, tipo:
          <code>debug_0.wav</code>, <code>debug_1.wav</code>,
          <code>debug_2.wav</code>, e por a√≠ vai.
        </p>
        <p>Depois juntei tudo com o <code>ffmpeg</code>:</p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#89B4FA;font-style:italic">ffmpeg</span><span style="color:#A6E3A1"> -f</span><span style="color:#A6E3A1"> concat</span><span style="color:#A6E3A1"> -safe</span><span style="color:#FAB387"> 0</span><span style="color:#A6E3A1"> -i</span><span style="color:#A6E3A1"> input.txt</span><span style="color:#A6E3A1"> -c</span><span style="color:#A6E3A1"> copy</span><span style="color:#A6E3A1"> out.wav</span></span></code></pre>
        <p>E o arquivo <code>input.txt</code> fica assim:</p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#89B4FA;font-style:italic">file</span><span style="color:#A6E3A1"> 'debug_0.wav'</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">file</span><span style="color:#A6E3A1"> 'debug_1.wav'</span></span>
<span class="line"><span style="color:#89B4FA;font-style:italic">file</span><span style="color:#A6E3A1"> 'debug_2.wav'</span></span></code></pre>
        <p>
          At√© esse ponto, tava tudo fluindo lindamente. Eu j√° tava achando que
          ia dar bom. Mas... o resultado final foi bem mais ou menos.
        </p>
        <hr />
        <h3>(ü§î SUCCESS?) os problemas!</h3>
        <p>
          √â aqui que entra o <code>whisper</code> de verdade. Testei um monte de
          coisas pra tentar deixar tudo o mais r√°pido poss√≠vel, e, claro, sem
          perder precis√£o na transcri√ß√£o.
        </p>
        <p>
          D√° uma olhada nos coment√°rios que deixei no c√≥digo. Logo mais abaixo
          eu explico outras coisas que descobri no caminho.
        </p>
        <p>
          Essa √© a fun√ß√£o <code>transcriber</code>, que fica rodando enquanto
          tem coisa na fila (<code>queue</code>). Comentei bastante no c√≥digo,
          mas aqui vai uma vis√£o geral com uns complementos:
        </p>
        <pre
          class="shiki catppuccin-mocha"
          style="background-color: #1e1e2e; color: #cdd6f4"
          tabindex="0"
        ><code><span class="line"><span style="color:#CBA6F7">async</span><span style="color:#CBA6F7"> def</span><span style="color:#89B4FA;font-style:italic"> transcriber</span><span style="color:#9399B2">(</span><span style="color:#EBA0AC;font-style:italic">queue</span><span style="color:#9399B2">):</span></span>
<span class="line"><span style="color:#CDD6F4">    prefix </span><span style="color:#94E2D5">=</span><span style="color:#A6E3A1"> ""</span><span style="color:#9399B2;font-style:italic">  # USEI ISSO DE DUAS FORMAS DIFERENTES, SEM SUCESSO</span></span>
<span class="line"><span style="color:#CBA6F7">    while</span><span style="color:#FAB387"> True</span><span style="color:#9399B2">:</span></span>
<span class="line"><span style="color:#FAB387;font-style:italic">        print</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1">"üí¨ Whisper started"</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # Pega o √°udio cru da fila</span></span>
<span class="line"><span style="color:#CDD6F4">        audio </span><span style="color:#94E2D5">=</span><span style="color:#CBA6F7"> await</span><span style="color:#CDD6F4"> queue</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">get</span><span style="color:#9399B2">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # Isso aqui √© um p√© no saco: n√£o importa o tamanho real do √°udio,</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # o whisper sempre espera cerca de 30s.</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        #</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # Se for menor, ele preenche o resto com zeros (sil√™ncio).</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # Se for maior, ele corta o que passa dos 30s.</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        #</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # IMPORTANTE: n√£o tem como passar √°udios de dura√ß√µes diferentes</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # usando o c√≥digo da OpenAI, porque o modelo foi treinado assim.</span></span>
<span class="line"><span style="color:#CDD6F4">        audio </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">pad_or_trim</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # O whisper n√£o "ouve" o som, ele transforma em imagem.</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # √â um gr√°fico do som chamado espectrograma (Mel logar√≠tmico).</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # J√° expliquei isso num v√≠deo, √© bem de boa de entender.</span></span>
<span class="line"><span style="color:#CDD6F4">        mel </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">log_mel_spectrogram</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">audio</span><span style="color:#9399B2">,</span><span style="color:#EBA0AC;font-style:italic"> n_mels</span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4">MODEL</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">dims</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">n_mels</span><span style="color:#9399B2">).</span><span style="color:#89B4FA">to</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#CDD6F4">            MODEL</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">device</span></span>
<span class="line"><span style="color:#9399B2">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">        options </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">DecodingOptions</span><span style="color:#9399B2">(</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # √öltimo teste: ingl√™s (en)</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # Mas 90% dos testes foram em portugu√™s (pt), com √°udios limpos,</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # de v√≠deos do YouTube com gente falando claro, sem g√≠ria nem ru√≠do.</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            language</span><span style="color:#94E2D5">=</span><span style="color:#A6E3A1">"en"</span><span style="color:#9399B2">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # Tentei deixar mais r√°pido usando o modo "greedy"</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # Tamb√©m expliquei isso no outro v√≠deo</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            temperature</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">0</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            beam_size</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">1</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            patience</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">0</span><span style="color:#9399B2">,</span><span style="color:#9399B2;font-style:italic">  # isso aqui nem faz nada, foi mais no desespero</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # Desativei os timestamps pra ver se o modelo ficava mais leve,</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # focando s√≥ na transcri√ß√£o mesmo</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            without_timestamps</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">True</span><span style="color:#9399B2">,</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # Aquele prefixo l√° de cima... tentei usar nessas duas op√ß√µes aqui</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # (prompt e prefix). O modelo entrou em loop e fiquei bolado.</span></span>
<span class="line"><span style="color:#9399B2;font-style:italic">            # Desisti de usar.</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            prompt</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">None</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#EBA0AC;font-style:italic">            prefix</span><span style="color:#94E2D5">=</span><span style="color:#FAB387">None</span><span style="color:#9399B2">,</span></span>
<span class="line"><span style="color:#9399B2">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9399B2;font-style:italic">        # E aqui √© onde rola a transcri√ß√£o de fato</span></span>
<span class="line"><span style="color:#CDD6F4">        result </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> whisper</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">decode</span><span style="color:#9399B2">(</span><span style="color:#CDD6F4">MODEL</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> mel</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> options</span><span style="color:#9399B2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CDD6F4">        prefix </span><span style="color:#94E2D5">=</span><span style="color:#CDD6F4"> result</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">text</span></span>
<span class="line"><span style="color:#FAB387;font-style:italic">        print</span><span style="color:#9399B2">(</span><span style="color:#A6E3A1">"üí¨"</span><span style="color:#9399B2">,</span><span style="color:#CDD6F4"> result</span><span style="color:#9399B2">.</span><span style="color:#CDD6F4">text</span><span style="color:#9399B2">,</span><span style="color:#A6E3A1"> "</span><span style="color:#F5C2E7">\n</span><span style="color:#A6E3A1">"</span><span style="color:#9399B2">)</span></span>
<span class="line"><span style="color:#CDD6F4">        queue</span><span style="color:#9399B2">.</span><span style="color:#89B4FA">task_done</span><span style="color:#9399B2">()</span></span></code></pre>
        <p>
          Tentei detalhar bastante nos coment√°rios do c√≥digo acima, mas ainda
          tem umas coisas importantes que vale comentar.
        </p>
        <p>
          Primeiro:
          <strong
            >n√£o consegui usar nenhum modelo acima do
            <code>medium</code></strong
          >. O motivo √© simples, o tempo de transcri√ß√£o ficava maior do que a
          janela de tempo que eu escolhi.
        </p>
        <p>
          Tipo assim: com o modelo <code>turbo</code> e uma janela de 2
          segundos, o <code>whisper</code> levava uns 10 segundos (ou mais!) pra
          cuspir a transcri√ß√£o. Ou seja, <strong>n√£o dava tempo</strong>. N√£o
          tinha como rodar em tempo real desse jeito. Pode ser limita√ß√£o do meu
          hardware tamb√©m? Pode. Mas o fato √© que n√£o rolou.
        </p>
        <p>
          Os modelos que <strong>se sa√≠ram melhor</strong> nesse esquema foram o
          <code>tiny</code> e o <code>base</code>. Ambos ainda s√£o imprecisos,
          mas se eu tivesse que escolher um, ficaria com o <code>base</code>. O
          <code>tiny</code>, cara... entra em loop com uma facilidade absurda,
          qualquer coisa repete, embanana, e vira um samba do sussurrador doido.
        </p>
        <p>Sobre os tempos, testei com v√°rias janelas diferentes:</p>
        <ul>
          <li>
            ‚ö†Ô∏è <strong>1s, 2s, 3s, 4s:</strong> sem chance. O modelo n√£o entende
            nada, e em poucos ciclos j√° come√ßa a repetir as coisas.
          </li>
          <li>
            ‚ö†Ô∏è <strong>5s a 9s:</strong> at√© vai, mas ainda rola loop e perda de
            qualidade em alguns momentos.
          </li>
          <li>
            ‚úÖ <strong>10s a 30s:</strong> aqui a coisa come√ßou a funcionar de
            verdade. Foi a faixa que deu o melhor resultado.
          </li>
        </ul>
        <p>
          Percebeu o paradoxo? Eu queria uma parada em <em>tempo real</em>, mas
          s√≥ come√ßou a ficar us√°vel a partir dos 10 segundos de √°udio por vez.
          Foi a√≠ que me bateu a real: talvez s√≥ role se eu refinar o modelo e
          usar um c√≥digo customizado, sem depender da implementa√ß√£o padr√£o do
          <code>whisper</code>.
        </p>
        <p>
          Todos esses testes foram feitos usando exatamente o c√≥digo oficial da
          OpenAI. Nada modificado no core do modelo.
        </p>
        <hr />
        <h2>Conclus√£o geral</h2>
        <p>
          Desse jeito que mostrei at√© aqui, pra mim
          <strong
            >n√£o rola usar o <code>whisper</code> com precis√£o em tempo
            real</strong
          >. Pelo menos foi essa a conclus√£o que cheguei depois de tudo isso.
        </p>
        <p>
          Mas √≥: foi uma experi√™ncia massa. Aprendi muita coisa que eu nem fazia
          ideia, principalmente sobre √°udio, e me diverti bastante fu√ßando esse
          modelo.
        </p>
        <p>
          T√¥ deixando tudo documentado aqui porque pode ser que te ajude a ir
          mais fundo no modelo, ou at√© mexer no c√≥digo do
          <code>whisper</code> pra tentar um resultado melhor que o meu.
        </p>
        <p>
          Outra op√ß√£o que eu <em>n√£o testei</em>, mas pode valer muito a pena,
          seria usar o
          <a href="https://github.com/ggerganov/whisper.cpp"
            ><code>whisper.cpp</code></a
          >
          (vers√£o C++) ou o
          <a href="https://github.com/guillaumekln/faster-whisper"
            ><code>faster-whisper</code></a
          >, que √© uma implementa√ß√£o otimizada em Python com base no
          CTranslate2.
        </p>
        <p>
          Valeu demais se tu leu at√© aqui! Tomara que eu tenha te ajudado ou
          feito voc√™ perder menos tempo se fosse testar tudo isso que testei.
        </p>
        <p>
          <strong>Obs:</strong> escrevi esse texto com <code>markdown</code>, se
          quiser baixar:
        </p>
        <ul>
          <li>
            <a href="TEXT.md">Baixar esse texto em <code>markdown</code></a>
          </li>
        </ul>
        <p>Bye üëã!!!</p>
        <hr />
      </article>

      <footer class="nav">
        <a class="copyright-link" href="/">Ot√°vio Miranda</a>
        <a
          target="_blank"
          href="https://beacons.ai/otaviomiranda"
          rel="nofollow noopener noreferrer"
          >Contatos</a
        >
      </footer>
    </main>

    <script defer src="../../js/scripts_2026.js"></script>
  </body>
</html>
