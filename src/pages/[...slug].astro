---
/**
 * ARQUIVO: [...slug].astro
 *
 * O QUE FAZ:
 *   Pagina dinamica que renderiza cada post individual do blog. Busca todos os
 *   posts da content collection "posts", gera um caminho (slug) para cada um
 *   via getEntrySlugPath, e renderiza o conteudo Markdown como HTML. Exibe
 *   titulo, autor, data de publicacao e o corpo do artigo.
 *
 * USADO EM:
 *   - Qualquer URL de post, por exemplo:
 *     https://otaviomiranda.com.br/2024/meu-post-exemplo/
 *     O slug pode conter barras (ex: "2024/titulo-do-post"), por isso usa
 *     o rest parameter [...slug] em vez de [slug].
 *
 * CONCEITO ASTRO:
 *   Rest parameters em rotas dinamicas — o [...slug] (com "...") captura
 *   multiplos segmentos de URL (ex: /2024/titulo vira slug = "2024/titulo").
 *   Diferente de [slug], que captura apenas UM segmento.
 *
 *   getStaticPaths() — funcao OBRIGATORIA em rotas dinamicas no modo SSG
 *   (Static Site Generation). Ela roda no build e retorna um array de objetos
 *   { params, props } que dizem ao Astro QUAIS paginas gerar. Cada objeto
 *   gera uma pagina HTML estatica.
 *
 *   Content Collections — os posts ficam em src/content/posts/ e sao
 *   acessados via getCollection('posts'). A funcao render(entry) converte
 *   o Markdown/MDX em um componente <Content /> que pode ser usado no template.
 *
 *   Astro.props — recebe os dados passados pelo objeto "props" retornado
 *   em getStaticPaths(). Aqui, recebe a entry completa do post.
 */
import { getCollection, render, type CollectionEntry } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import Newsletter from '../components/Newsletter.astro';
import { getEntrySlugPath } from '../utils/post-path';
import Section from '../components/Section.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('posts');
  return blogEntries.map((entry: CollectionEntry<'posts'>) => {
    const slugPath = getEntrySlugPath(entry);

    return {
      params: { slug: slugPath },
      props: { entry },
    };
  });
}

interface Props {
  entry: CollectionEntry<'posts'>;
}

const { entry } = Astro.props;
const { Content } = await render(entry);
---

<BaseLayout
  title={entry.data.title + ' - Otávio Miranda'}
  description={entry.data.description}
  image={entry.data.image}
>
  <Header />

  <ThemeToggle />

  <Section id='post-content' class='article-section' contentClass='section-blog'>
    <article class='article markdown-body article-body'>
      <header class='post-header'>
        <h1 class='post-title'>{entry.data.title}</h1>
        <div class='post-meta'>
          {
            entry.data.author && (
              <span class='post-author'>{entry.data.author}</span>
            )
          }
          {
            entry.data.date && (
              <time class='post-date' datetime={entry.data.date.toISOString()}>
                {entry.data.date.toLocaleDateString('pt-BR', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </time>
            )
          }
        </div>
      </header>

      <Content />
    </article>
  </Section>

  <Newsletter />
  <Footer />
</BaseLayout>

<style>
  .post-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacings-sm-100) var(--spacings-sm-500);
    color: hsl(from var(--main-clr-shade) h 10% 50% / 1);
    font-size: var(--font-size-sm);
  }
</style>
