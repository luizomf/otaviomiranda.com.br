---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Newsletter from '../../components/Newsletter.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPathsOptions, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';
import {
  comparePostsByDateDesc,
  getEntryDateLabel,
  getEntryDateTimeAttr,
} from '../../utils/post-date';
import { getEntryHref } from '../../utils/post-path';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getCollection('posts');
  posts.sort(comparePostsByDateDesc);
  return paginate(posts, { pageSize: 10 });
}

interface Props {
  page: Page<CollectionEntry<'posts'>>;
}

const { page } = Astro.props as Props;
const paginatedPosts = page.data.map((post: CollectionEntry<'posts'>) => ({
  post,
  dateLabel: getEntryDateLabel(post),
  dateTime: getEntryDateTimeAttr(post),
}));
---

<BaseLayout>
  <div class='main'>
    <Header />

    <section id='blog-page' class='section section-light article-section'>
      <div class='section-content'>
        <article class='article markdown-body article-body blog-archive-body'>
          <header class='blog-archive-heading'>
            <p class='blog-archive-eyeball'>Arquivo</p>
            <h1 class='blog-archive-title'>Todos os posts</h1>
            <p class='blog-archive-line'>
              Página {page.currentPage} de {page.lastPage}. Explorando o acervo de
              tutoriais e anotações.
            </p>
          </header>

          <ul class='blog-list'>
            {
              paginatedPosts.map(({ post, dateLabel, dateTime }) => (
                <li class='blog-post-item'>
                  <a href={getEntryHref(post)} class='blog-post-link'>
                    {post.data.title}
                  </a>
                  {post.data.description && (
                    <p class='blog-post-description'>{post.data.description}</p>
                  )}
                  {dateLabel && dateTime && (
                    <time datetime={dateTime} class='blog-post-date'>
                      {dateLabel}
                    </time>
                  )}
                </li>
              ))
            }
          </ul>

          <div class='pagination blog-pagination'>
            {
              page.url.prev ? (
                <a
                  href={page.url.prev}
                  class='button blog-pagination-button blog-pagination-button--prev'
                >
                  &larr; Página Anterior
                </a>
              ) : (
                <span class='blog-pagination-placeholder' />
              )
            }

            <span class='blog-pagination-current'>
              Página {page.currentPage}
            </span>

            {
              page.url.next ? (
                <a
                  href={page.url.next}
                  class='button blog-pagination-button blog-pagination-button--next'
                >
                  Próxima Página &rarr;
                </a>
              ) : (
                <span class='blog-pagination-placeholder' />
              )
            }
          </div>
        </article>
      </div>
    </section>
  </div>

  <Newsletter />
  <Footer />
</BaseLayout>

<style>
  .blog-archive-body {
    padding-bottom: 8rem;
  }

  .blog-archive-heading {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
    padding: clamp(var(--spacings-sm-800), 4vw, var(--spacings-lg-200)) 0
      clamp(var(--spacings-sm-600), 3vw, var(--spacings-lg-100));
    margin-bottom: clamp(var(--spacings-sm-600), 4vw, var(--spacings-lg-200));
  }

  .blog-archive-eyeball {
    margin: 0 0 var(--spacings-sm-100);
    font-size: var(--font-size-xxsm);
    color: hsl(from var(--main-clr-shade) h s 30% / 1);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 600;
  }

  .blog-archive-title {
    margin: var(--spacings-sm-400) 0;
    font-size: var(--font-size-h-me);
    line-height: 1.1;
    letter-spacing: -0.04em;
    font-weight: 800;
  }

  .blog-archive-line {
    margin: 0;
    color: hsl(from var(--main-clr-shade) h s 30% / 1);
    font-size: clamp(var(--font-size-sm), 3vw, var(--font-size-md));
    max-width: none;
  }

  .blog-post-item {
    margin-bottom: 2rem;
  }

  .blog-post-link {
    display: block;
    font-size: var(--font-size-md);
    font-weight: 700;
    color: var(--main-clr-shade);
    text-decoration: none;
    margin-bottom: 0.5rem;
  }

  .blog-post-description {
    color: hsl(from var(--main-clr-shade) h s 40% / 1);
    font-size: var(--font-size-sm);
    margin: 0;
  }

  .blog-post-date {
    font-size: var(--font-size-xxsm);
    color: hsl(from var(--main-clr-shade) h s 60% / 1);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .blog-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid hsl(from var(--main-clr-shade) h s 90% / 1);
  }

  .blog-pagination-button {
    padding: 0.8rem 1.6rem;
    text-decoration: none;
    font-weight: 700;
    border: 2px solid var(--main-clr-shade);
    border-radius: 4px;
  }

  .blog-pagination-button--prev {
    background-color: transparent;
    color: var(--main-clr-shade);
  }

  .blog-pagination-button--next {
    background-color: var(--main-clr-shade);
    color: var(--main-clr);
  }

  .blog-pagination-placeholder {
    opacity: 0.5;
    padding: 0.8rem 1.6rem;
    border: 2px solid transparent;
  }

  .blog-pagination-current {
    font-weight: 600;
    color: hsl(from var(--main-clr-shade) h s 50% / 1);
  }
</style>
