---
/**
 * ARQUIVO: blog/[page].astro
 *
 * O QUE FAZ:
 *   Pagina de arquivo (listagem) do blog com paginacao. Exibe todos os posts
 *   ordenados por data (mais recente primeiro), com 10 posts por pagina.
 *   Mostra titulo, descricao e data de cada post, alem de controles de
 *   navegacao (anterior/proxima) entre as paginas.
 *
 * USADO EM:
 *   - https://otaviomiranda.com.br/blog/1 (primeira pagina)
 *   - https://otaviomiranda.com.br/blog/2 (segunda pagina)
 *   - E assim por diante, uma pagina para cada grupo de 10 posts.
 *
 * CONCEITO ASTRO:
 *   Rota dinamica com paginacao — o [page] no nome do arquivo indica um
 *   parametro dinamico de URL. O Astro fornece a funcao paginate() dentro
 *   de getStaticPaths() que automaticamente divide os dados em paginas e
 *   gera as rotas /blog/1, /blog/2, etc.
 *
 *   GetStaticPathsOptions — o tipo que fornece a funcao paginate() como
 *   argumento de getStaticPaths(). Ao chamar paginate(posts, { pageSize: 10 }),
 *   o Astro gera automaticamente os params e props de cada pagina.
 *
 *   Page<T> — o tipo do objeto de paginacao recebido via Astro.props. Contem:
 *   - page.data: array dos itens da pagina atual
 *   - page.currentPage / page.lastPage: numeros da pagina
 *   - page.url.prev / page.url.next: URLs de navegacao (ou undefined)
 *
 *   Content Collections — os posts sao buscados via getCollection('posts')
 *   e ordenados com comparePostsByDateDesc antes de paginar.
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Newsletter from '../../components/Newsletter.astro';
import PillLink from '../../components/PillLink.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPathsOptions, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';
import {
  comparePostsByDateDesc,
  getEntryDateLabel,
  getEntryDateTimeAttr,
} from '../../utils/post-date';
import { getEntryHref } from '../../utils/post-path';
import Section from '../../components/Section.astro';
import SectionHeader from '../../components/SectionHeader.astro';
import ThemeToggle from '../../components/ThemeToggle.astro';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getCollection('posts');
  posts.sort(comparePostsByDateDesc);
  return paginate(posts, { pageSize: 10 });
}

interface Props {
  page: Page<CollectionEntry<'posts'>>;
}

const { page } = Astro.props as Props;
const paginatedPosts = page.data.map((post: CollectionEntry<'posts'>) => ({
  post,
  dateLabel: getEntryDateLabel(post),
  dateTime: getEntryDateTimeAttr(post),
}));
---

<BaseLayout>
  <Header />

  <ThemeToggle />

  <Section
    id='blog-archive'
    class='article-section'
    theme='light'
    contentClass='section-blog'
  >
    <SectionHeader
      class='blog-header'
      eyeball='Arquivo'
      title='Todos os posts'
      description={`Página ${page.currentPage} de ${page.lastPage}. Explorando o acervo de tutoriais e anotações.`}
    />

    <article class='article markdown-body article-body blog-archive-body'>
      <ul class='blog-list'>
        {
          paginatedPosts.map(({ post, dateLabel, dateTime }) => (
            <li class='blog-post-item'>
              <a href={getEntryHref(post)} class='blog-post-link'>
                {post.data.title}
              </a>
              {post.data.description && (
                <p class='blog-post-description'>{post.data.description}</p>
              )}
              {dateLabel && dateTime && (
                <time datetime={dateTime} class='blog-post-date'>
                  {dateLabel}
                </time>
              )}
            </li>
          ))
        }
      </ul>

      <div class='pagination blog-pagination'>
        <div class='blog-pagination-side blog-pagination-side--prev'>
          {
            page.url.prev && (
              <PillLink
                href={page.url.prev}
                containerClass='blog-pagination-control'
                linkClass='blog-pagination-link'
              >
                ◀ Anterior
              </PillLink>
            )
          }
        </div>

        <span class='blog-pagination-current'>
          ▲ Página {page.currentPage}
        </span>

        <div class='blog-pagination-side blog-pagination-side--next'>
          {
            page.url.next && (
              <PillLink
                href={page.url.next}
                containerClass='blog-pagination-control'
                linkClass='blog-pagination-link'
              >
                Próxima ▶
              </PillLink>
            )
          }
        </div>
      </div>
    </article>
  </Section>

  <Newsletter />
  <Footer />
</BaseLayout>

<style>
  .blog-list {
    margin: 0;
    list-style: none;
  }

  .blog-header {
    margin-bottom: clamp(var(--spacings-sm-600), 5vw, var(--spacings-sm-900));
  }

  .blog-archive-body {
    padding-bottom: 8rem;
  }

  .blog-post-item {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
  }

  .blog-post-link.blog-post-link {
    display: block;
    font-size: var(--font-size-me);
    font-weight: 700;
    color: var(--main-clr-shade);
    text-decoration: none;
    padding: 1rem 0;
  }

  .blog-post-description {
    color: var(--color-text-subtle);
    font-size: var(--font-size-body-sm);
    margin: 0;
    padding-bottom: var(--spacings-sm-300);
  }

  .blog-post-date {
    font-size: var(--font-size-label);
    color: var(--color-text-soft);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .blog-pagination {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    justify-items: center;
    align-items: center;
    gap: var(--spacings-sm-600) var(--spacings-sm-500);
    margin-block: var(--spacings-sm-700);
    padding-block: var(--spacings-sm-700);
  }

  .blog-pagination-side {
    display: flex;
  }

  .blog-pagination-side--prev {
    justify-content: flex-start;
  }

  .blog-pagination-side--next {
    justify-content: flex-end;
  }

  .blog-pagination-control {
    flex: 0 0 auto;
    min-width: 22rem;
    max-width: 100%;
  }

  .blog-pagination-side :global(.blog-pagination-link) {
    display: flex;
    width: 100%;
    justify-content: center;
    align-items: center;
    font-size: var(--font-size-xsm);
    text-decoration: none;
    white-space: nowrap;
  }

  .blog-pagination-current {
    --clr: hsl(from var(--main-clr-shade) h s 60% / 1);

    color: var(--clr);
    font-size: var(--font-size-xsm);
    border: 2px solid var(--clr);

    line-height: var(--line-height-xxxsm);
    border-radius: var(--border-radius-pill);
    font-family: var(--font-family-monospace);
    padding: clamp(var(--spacings-sm-200), 3vw, var(--spacings-sm-300))
      clamp(var(--spacings-sm-400), 3vw, var(--spacings-sm-900));
  }

  @media (max-width: 500px) {
    .blog-pagination {
      grid-template-columns: 1fr;
      justify-items: stretch;
    }

    .blog-pagination-side--next {
      justify-content: flex-start;
    }

    .blog-pagination-current {
      justify-self: flex-start;
      width: 100%;
      text-align: center;
    }

    .blog-pagination-control {
      min-width: 0;
      width: 100%;
    }
  }
</style>
